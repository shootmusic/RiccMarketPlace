<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Ricc Market</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0f;
            color: white;
        }
        .navbar {
            background: #111118;
            border-bottom: 1px solid #222230;
            padding: 16px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #0066ff, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nav-actions a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #222230;
            margin-left: 10px;
        }
        .dashboard-container {
            display: flex;
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
            gap: 30px;
        }
        .sidebar {
            width: 260px;
            background: #111118;
            border: 1px solid #222230;
            border-radius: 16px;
            padding: 24px 0;
            height: fit-content;
        }
        .user-info {
            padding: 0 20px 20px;
            border-bottom: 1px solid #222230;
            margin-bottom: 16px;
        }
        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        .user-email {
            color: #a0a0b0;
            font-size: 0.85rem;
        }
        .sidebar-menu {
            list-style: none;
        }
        .sidebar-menu li {
            margin-bottom: 4px;
        }
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #a0a0b0;
            text-decoration: none;
            cursor: pointer;
        }
        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: #1a1a2a;
            color: white;
            border-left: 3px solid #0066ff;
        }
        .sidebar-menu a i {
            width: 20px;
            color: #0066ff;
        }
        .main-content {
            flex: 1;
        }
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .content-header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, white, #a0a0b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-primary {
            background: linear-gradient(135deg, #0066ff, #00ccff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,102,255,0.3);
        }
        .store-card {
            background: #111118;
            border: 1px solid #222230;
            border-radius: 16px;
            padding: 40px 30px;
            text-align: center;
        }
        .store-card i {
            font-size: 4rem;
            color: #0066ff;
            margin-bottom: 20px;
        }
        .store-card h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        .store-card p {
            color: #a0a0b0;
            margin-bottom: 25px;
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .product-card {
            background: #111118;
            border: 1px solid #222230;
            border-radius: 12px;
            padding: 20px;
        }
        .product-card h3 {
            margin-bottom: 10px;
        }
        .product-card p {
            color: #a0a0b0;
            margin-bottom: 15px;
        }
        .product-price {
            color: #0066ff;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .hidden {
            display: none !important;
        }
        .upload-link {
            display: inline-block;
            background: linear-gradient(135deg, #0066ff, #00ccff);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">Ricc Market</div>
        <div class="nav-actions">
            <a href="/">Home</a>
            <a href="#" id="logoutBtn">Logout</a>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="user-info">
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-email" id="userEmail">Loading...</div>
            </div>
            
            <ul class="sidebar-menu">
                <li><a class="active" onclick="showTab('home')"><i class="fas fa-home"></i> Home</a></li>
                <li><a onclick="showTab('store')"><i class="fas fa-store"></i> Toko Saya</a></li>
                <li><a onclick="showTab('products')"><i class="fas fa-box"></i> Produk Saya</a></li>
                <li><a onclick="showTab('profile')"><i class="fas fa-user"></i> Profil</a></li>
            </ul>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- HOME TAB -->
            <div id="home-tab">
                <div class="content-header">
                    <h1>Semua Produk</h1>
                </div>
                <div id="allProducts" class="products-grid">
                    <div class="store-card">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Memuat produk...</p>
                    </div>
                </div>
            </div>

            <!-- STORE TAB -->
            <div id="store-tab" class="hidden">
                <div class="content-header">
                    <h1>Toko Saya</h1>
                </div>
                <div id="storeContent"></div>
            </div>

            <!-- PRODUCTS TAB -->
            <div id="products-tab" class="hidden">
                <div class="content-header">
                    <h1>Produk Saya</h1>
                    <!-- ===== FIX: TOMBOL UPLOAD LANGSUNG KE HALAMAN UPLOAD ===== -->
                    <a href="/#upload" class="btn-primary">
                        <i class="fas fa-plus"></i> Upload Produk
                    </a>
                </div>
                <div id="myProductsContent"></div>
            </div>

            <!-- PROFILE TAB -->
            <div id="profile-tab" class="hidden">
                <div class="content-header">
                    <h1>Profil Saya</h1>
                </div>
                <div id="profileContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentStore = null;

        async function checkAuth() {
            try {
                const res = await fetch('/api/me');
                const data = await res.json();
                
                if (data.user) {
                    currentUser = data.user;
                    document.getElementById('userName').textContent = currentUser.name;
                    document.getElementById('userEmail').textContent = currentUser.email;
                    
                    await loadStore();
                    await loadAllProducts();
                } else {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = '/login.html';
            }
        }

        async function loadStore() {
            try {
                const res = await fetch('/api/my-store');
                const data = await res.json();
                
                const storeContent = document.getElementById('storeContent');
                
                if (data.store) {
                    currentStore = data.store;
                    storeContent.innerHTML = `
                        <div class="store-card">
                            <i class="fas fa-store"></i>
                            <h3>${currentStore.name}</h3>
                            <p>${currentStore.description || 'Toko tanpa deskripsi'}</p>
                            <p><strong>Total Produk:</strong> ${currentStore.products?.length || 0}</p>
                        </div>
                    `;
                    
                    await loadMyProducts();
                } else {
                    currentStore = null;
                    storeContent.innerHTML = `
                        <div class="store-card">
                            <i class="fas fa-store"></i>
                            <h3>Buka Toko</h3>
                            <p>Anda belum memiliki toko. Buat toko untuk mulai menjual.</p>
                            <button class="btn-primary" onclick="createStore()">Buka Toko</button>
                        </div>
                    `;
                    
                    document.getElementById('myProductsContent').innerHTML = `
                        <div class="store-card">
                            <i class="fas fa-store"></i>
                            <h3>Buka toko dulu</h3>
                            <p>Buat toko untuk mulai menjual</p>
                            <button class="btn-primary" onclick="showTab('store')">Buka Toko</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load store error:', error);
            }
        }

        async function loadAllProducts() {
            try {
                const res = await fetch('/api/products');
                const products = await res.json();
                
                const container = document.getElementById('allProducts');
                
                if (products.length === 0) {
                    container.innerHTML = '<div class="store-card">Belum ada produk</div>';
                    return;
                }
                
                container.innerHTML = products.map(p => `
                    <div class="product-card">
                        <h3>${p.title}</h3>
                        <p>${p.description?.substring(0, 60)}...</p>
                        <div class="product-price">Rp ${(p.price * 1000000).toLocaleString()}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load products error:', error);
                document.getElementById('allProducts').innerHTML = '<div class="store-card">Gagal memuat produk</div>';
            }
        }

        async function loadMyProducts() {
            if (!currentStore) return;
            
            try {
                const res = await fetch(`/api/products/store/${currentStore.id}`);
                const products = await res.json();
                
                const container = document.getElementById('myProductsContent');
                
                if (products.length === 0) {
                    container.innerHTML = `
                        <div class="store-card">
                            <i class="fas fa-box-open"></i>
                            <h3>Belum ada produk</h3>
                            <p>Upload produk pertama Anda</p>
                            <a href="/#upload" class="btn-primary">Upload Produk</a>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="products-grid">
                        ${products.map(p => `
                            <div class="product-card">
                                <h3>${p.title}</h3>
                                <p>${p.description?.substring(0, 50)}...</p>
                                <div class="product-price">Rp ${(p.price * 1000000).toLocaleString()}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Load my products error:', error);
            }
        }

        function loadProfile() {
            const profileContent = document.getElementById('profileContent');
            profileContent.innerHTML = `
                <div class="store-card">
                    <i class="fas fa-user"></i>
                    <h3>${currentUser?.name}</h3>
                    <p>Email: ${currentUser?.email}</p>
                    <p>Member sejak: ${new Date().toLocaleDateString()}</p>
                </div>
            `;
        }

        async function createStore() {
            const name = prompt('Masukkan nama toko:');
            if (!name) return;
            
            try {
                const res = await fetch('/api/create-store', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ storeName: name, storeDescription: '' })
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('Toko berhasil dibuat!');
                    await loadStore();
                    showTab('store');
                } else {
                    alert(data.error || 'Gagal buat toko');
                }
            } catch (error) {
                alert('Gagal buat toko');
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('home-tab').classList.add('hidden');
            document.getElementById('store-tab').classList.add('hidden');
            document.getElementById('products-tab').classList.add('hidden');
            document.getElementById('profile-tab').classList.add('hidden');
            
            document.getElementById(`${tab}-tab`).classList.remove('hidden');
            
            if (tab === 'profile') loadProfile();
        }

        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        });

        checkAuth();
    </script>
</body>
</html>
